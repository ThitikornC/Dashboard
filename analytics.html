<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô - Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/analytics.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<!-- Login Modal -->
<div id="loginModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:linear-gradient(180deg, #f8f6f0 0%, #fffef8 45%, #fff8e8 55%, #f5f0e5 100%); padding:40px; border-radius:20px; border:6px solid #74640a; box-shadow:1px 1px 0 #000, -8px 6px #3b3305, 0 0 30px rgba(255,230,160,0.7); max-width:400px; width:90%; text-align:center;">
    <h2 style="color:#333; margin-bottom:10px; font-size:28px;">üîí ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Analytics</h2>
    <p style="color:#666; margin-bottom:30px; font-size:14px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
    
    <input type="password" id="passwordInput" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" 
      style="width:100%; padding:15px; font-size:16px; border:2px solid #ddd; border-radius:10px; margin-bottom:10px; box-sizing:border-box; transition:border-color 0.3s;"
      onkeypress="if(event.key==='Enter') checkPassword()">
    
    <div id="errorMessage" style="color:#e74c3c; font-size:14px; margin-bottom:15px; min-height:20px; font-weight:500;"></div>
    
    <button onclick="checkPassword()" 
      style="width:100%; padding:15px; background:linear-gradient(180deg, #f8f6f0 0%, #fff8e8 100%); color:#000; border:4px solid #74640a; border-radius:10px; font-size:16px; font-weight:700; cursor:pointer; transition:all 0.3s; margin-bottom:10px; box-shadow:1px 1px 0 #000, -4px 3px #3b3305;">
      ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
    </button>
    
    <button onclick="window.location.href='menu.html'" 
      style="width:100%; padding:15px; background:linear-gradient(180deg, #e74c3c 0%, #c0392b 100%); color:white; border:4px solid #8b0000; border-radius:10px; font-size:16px; font-weight:700; cursor:pointer; transition:all 0.3s; box-shadow:1px 1px 0 #000, -4px 3px #4a0000;">
      ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
    </button>
    
    <div style="margin-top:20px; padding-top:20px; border-top:1px solid #eee;">
      <p style="color:#999; font-size:12px; margin:0;">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: <code style="background:#f0f0f0; padding:2px 8px; border-radius:4px; color:#667eea;">240124</code></p>
    </div>
  </div>
</div>

<div class="container" id="dashboardContainer" style="display:none;">
  <!-- Header -->
  <div class="header">
    <h1>Esspresso ‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡∏ï‡∏≥‡∏ö‡∏•‡∏´‡∏±‡∏ß‡∏£‡∏≠</h1>
    <div class="header-actions">
      <button class="btn btn-danger" onclick="logout()" style="background:#e67e22;">üîí ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
    <div style="width:100%; margin-top:10px; font-size:13px; color:#666; display:flex; justify-content:flex-start; align-items:center; gap:12px;">
      <div id="lastUpdate" style="font-size:13px; color:#666;">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: -</div>
      <div id="currentUTC7" style="font-size:13px; color:#666;">UTC+7: -</div>
    </div>
    
    <!-- Date Filter Section -->

    

  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-card-header">
        <div class="stat-title">‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç</div>
      </div>
      <div class="stat-value" id="totalVisits">0</div>
      <div class="stat-change positive">
        <div class="time-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô(‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</div>
      </div>
    </div>

  

    <div class="stat-card">
      <div class="stat-card-header">
        <div class="stat-title">‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</div>
      </div>
        <div class="stat-value" id="avgTime">0</div>
        <div class="time-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô(‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</div>
    </div>

    <div class="stat-card">
      <div class="stat-card-header">
        <div class="stat-title">‡πÇ‡∏´‡∏°‡∏î‡∏†‡∏≤‡∏©‡∏≤</div>
      </div>
      <div class="stat-value" id="activeUsers">0</div>
      <div class="stat-change positive">
                <div class="time-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô(‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</div>

      </div>
    </div>
  </div>

  <!-- Charts -->
  <div class="charts-grid">

    <div class="chart-card">
      <h3>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</h3>
      <canvas id="dailyUsageChart"></canvas>
    </div>
  </div>



  <!-- Feedback Section -->
  <div class="table-card" style="margin-top: 30px;">
    <div style="display: flex; align-items: center; margin-bottom: 20px;">
      <h3>üí¨ ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
    </div>
    <div id="feedbackContainer" style="max-height: 600px; overflow-y: auto;">
      <p style="text-align: center; color: #999; padding: 40px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞...</p>
    </div>
  </div>
</div>

<script>
// ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
const ANALYTICS_PASSWORD = '240124'; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
const AUTH_KEY = 'analyticsAuth';
const AUTH_TIMEOUT = 3600000; // 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (‡∏°‡∏¥‡∏•‡∏•‡∏¥‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)

// ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Date Filter (‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏∞‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ)
let currentStartDate = null;
let currentEndDate = null;

function checkAuth() {
  const auth = localStorage.getItem(AUTH_KEY);
  if (auth) {
    const authData = JSON.parse(auth);
    const now = Date.now();
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤
    if (now - authData.timestamp < AUTH_TIMEOUT) {
      showDashboard();
      return true;
    } else {
      localStorage.removeItem(AUTH_KEY);
    }
  }
  
  showLogin();
  return false;
}

// ‡∏î‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å API ‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å (fallback: ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ null ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)
async function fetchActiveClientsFromAPI() {
  try {
    // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏Å proxy ‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô (same-origin) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ CORS
    let res;
    try {
      res = await fetch('/api/active-clients', { cache: 'no-store' });
      console.debug('fetchActiveClientsFromAPI: tried local proxy /api/active-clients ->', res.status);
      if (!res.ok) throw new Error('Local proxy response was not ok');
    } catch (localErr) {
      console.debug('fetchActiveClientsFromAPI: local proxy failed, trying external api, reason:', localErr && localErr.message);
      // ‡∏ñ‡πâ‡∏≤ proxy ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å external ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡∏≠‡∏≤‡∏à‡πÇ‡∏î‡∏ô CORS)
      res = await fetch('https://huaroa-production.up.railway.app/api/active-clients', { cache: 'no-store' });
      console.debug('fetchActiveClientsFromAPI: external fetch response status', res.status, res.statusText);
      if (!res.ok) throw new Error('External network response was not ok');
    }

    const json = await res.json();
    console.debug('fetchActiveClientsFromAPI: raw json', json);
    console.debug('fetchActiveClientsFromAPI: raw json', json);
    // ‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Å‡∏±‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå `activeClients` (‡∏´‡∏£‡∏∑‡∏≠ `active_clients`) ‡πÄ‡∏™‡∏°‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ
    // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà response ‡∏ñ‡∏π‡∏Å‡∏´‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢ { success: true, activeClients: 0 }
    if (json && typeof json === 'object') {
      if ('activeClients' in json || 'active_clients' in json) {
        const val = json.activeClients ?? json.active_clients;
        console.debug('fetchActiveClientsFromAPI: found activeClients field ->', val);
        if (typeof val === 'number' && !Number.isNaN(val)) {
          try { localStorage.setItem('activeClientsFromAPI', String(val)); } catch(e){}
          return val;
        }
      }
    }

    // ‡∏ñ‡πâ‡∏≤ response ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ï‡∏£‡∏á‡πÜ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ
    if (typeof json === 'number') {
      try { localStorage.setItem('activeClientsFromAPI', String(json)); } catch(e){}
      return json;
    }

    // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö array ‡∏´‡∏£‡∏∑‡∏≠ property ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡πÄ‡∏õ‡πá‡∏ô fallback
    if (Array.isArray(json)) return json.length;

    if (json && typeof json === 'object') {
      const candidate = json.count ?? json.total ?? json.clients ?? null;
      if (typeof candidate === 'number' && !Number.isNaN(candidate)) {
        try { localStorage.setItem('activeClientsFromAPI', String(candidate)); } catch(e){}
        return candidate;
      }
      if (Array.isArray(json.data)) {
        try { localStorage.setItem('activeClientsFromAPI', String(json.data.length)); } catch(e){}
        return json.data.length;
      }
      if (Array.isArray(json.clients)) {
        try { localStorage.setItem('activeClientsFromAPI', String(json.clients.length)); } catch(e){}
        return json.clients.length;
      }
    }

    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡πà‡∏≤ ‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πà‡∏≤‡πÉ‡∏ô localStorage ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô null
    try { localStorage.removeItem('activeClientsFromAPI'); } catch(e){}
    return null;
  } catch (err) {
    console.error('Error fetching active clients from API:', err);
    try { localStorage.removeItem('activeClientsFromAPI'); } catch(e){}
    return null;
  }
}

// ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡∏ö distinct ‡∏à‡∏≤‡∏Å endpoint /status/active-clients
async function fetchDistinctClientsFromAPI() {
  try {
    let res;
    try {
      res = await fetch('/status/active-clients', { cache: 'no-store' });
      console.debug('fetchDistinctClientsFromAPI: tried local proxy /status/active-clients ->', res.status);
      if (!res.ok) throw new Error('Local proxy response was not ok');
    } catch (localErr) {
      console.debug('fetchDistinctClientsFromAPI: local proxy failed, trying external api, reason:', localErr && localErr.message);
      res = await fetch('https://huaroa-production.up.railway.app/status/active-clients', { cache: 'no-store' });
      console.debug('fetchDistinctClientsFromAPI: external fetch response status', res.status, res.statusText);
      if (!res.ok) throw new Error('External network response was not ok');
    }

    const json = await res.json();
    console.debug('fetchDistinctClientsFromAPI: raw json', json);

    // ‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Å‡∏±‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå totalEverUsers ‡∏Å‡πà‡∏≠‡∏ô (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠)
    if (json && typeof json === 'object') {
      const ever = json.totalEverUsers ?? json.totalEver ?? json.total_users ?? null;
      if (typeof ever === 'number' && !Number.isNaN(ever)) {
        try { localStorage.setItem('totalEverUsersFromAPI', String(ever)); } catch(e){}
        return ever;
      }

      // ‡∏ñ‡∏±‡∏î‡∏°‡∏≤‡πÉ‡∏ä‡πâ totalDistinctClientIds ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
      const totalDistinct = json.totalDistinctClientIds ?? json.totalDistinctClients ?? json.totalDistinct ?? null;
      if (typeof totalDistinct === 'number' && !Number.isNaN(totalDistinct)) {
        try { localStorage.setItem('totalDistinctFromAPI', String(totalDistinct)); } catch(e){}
        return totalDistinct;
      }

      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ counts object ‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô key ‡πÄ‡∏õ‡πá‡∏ô distinct ids
      if (json.counts && typeof json.counts === 'object') {
        try {
          const keys = Object.keys(json.counts);
          try { localStorage.setItem('totalDistinctFromAPI', String(keys.length)); } catch(e){}
          return keys.length;
        } catch (e) {
          // ignore
        }
      }
    }

    return null;
  } catch (err) {
    console.debug('Error fetching distinct clients from API:', err);
    return null;
  }
}

// ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ average usage (averageMinutes) ‡∏à‡∏≤‡∏Å endpoint /status/usage-average
async function fetchUsageAverageFromAPI() {
  try {
    let res;
    try {
      res = await fetch('/status/usage-average', { cache: 'no-store' });
      console.debug('fetchUsageAverageFromAPI: tried local proxy /status/usage-average ->', res.status);
      if (!res.ok) throw new Error('Local proxy response was not ok');
    } catch (localErr) {
      console.debug('fetchUsageAverageFromAPI: local proxy failed, trying external api, reason:', localErr && localErr.message);
      const externalUrl = 'https://huaroa-production.up.railway.app/status/usage-average?period=all%20|%20ConvertTo-Json%20-Depth%205';
      res = await fetch(externalUrl, { cache: 'no-store' });
      console.debug('fetchUsageAverageFromAPI: external fetch response status', res.status, res.statusText);
      if (!res.ok) throw new Error('External network response was not ok');
    }

    const json = await res.json();
    console.debug('fetchUsageAverageFromAPI: raw json', json);

    if (!json || typeof json !== 'object') return null;

    // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á response: { totalHours: 0.0687, averageMinutes: 4.12345, ... }
    // ‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Å‡∏±‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå `totalHours` ‡∏Å‡πà‡∏≠‡∏ô ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠
    let avg = json.totalHours ?? json.total_hours ?? null;
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ totalHours ‡πÉ‡∏´‡πâ fallback ‡πÑ‡∏õ‡∏´‡∏≤ averageMinutes ‡πÄ‡∏î‡∏¥‡∏° (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á)
    if (avg == null) avg = json.averageMinutes ?? json.average_minutes ?? json.averageMinute ?? null;
    if (avg == null) {
      // ‡∏ö‡∏≤‡∏á API ‡∏≠‡∏≤‡∏à‡∏´‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢ data ‡∏´‡∏£‡∏∑‡∏≠ value
      if (typeof json.data === 'object' && json.data !== null) {
        avg = json.data.averageMinutes ?? json.data.average_minutes ?? null;
      }
    }

    if (typeof avg === 'string') {
      const parsed = Number(avg);
      if (!Number.isNaN(parsed)) avg = parsed;
    }

    if (typeof avg === 'number' && !Number.isNaN(avg)) {
      try { localStorage.setItem('totalHoursFromAPI', String(avg)); } catch (e) {}
      return avg; // if this was averageMinutes fallback, it will be minutes ‚Äî callers should treat returned value as hours when totalHours present; fallback handling in callers will convert minutes->hours if needed
    }

    return null;
  } catch (err) {
    console.debug('Error fetching usage-average from API:', err);
    return null;
  }
}

// ----- Active Users Polling (lightweight) -----
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤ active users ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î dashboard ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
function updateActiveUsersOnce() {
  const activeElem = document.getElementById('activeUsers');
  if (!activeElem) return;

  // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏≠‡∏ú‡∏•
  activeElem.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';

  fetchActiveClientsFromAPI().then(count => {
    if (typeof count === 'number') {
      activeElem.textContent = count.toLocaleString();
    } else {
      // fallback: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô localStorage ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ
      const stored = localStorage.getItem('activeClientsFromAPI');
      if (stored !== null) {
        activeElem.textContent = Number(stored).toLocaleString();
      } else {
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ API ‡πÄ‡∏•‡∏¢ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ local ‡∏à‡∏≤‡∏Å analytics
        const analytics = new AnalyticsSystem();
        const data = analytics.getAnalytics();
        const uniquePlayers = new Set((data.gamePlays || []).map(p => p.playerName)).size;
        activeElem.textContent = uniquePlayers;
      }
    }
    try { activeElem.setAttribute('data-last-active-update', new Date().toISOString()); } catch(e){}
  }).catch(err => {
    console.debug('updateActiveUsersOnce failed:', err);
    // ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ error ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ fallback local
    const analytics = new AnalyticsSystem();
    const data = analytics.getAnalytics();
    const uniquePlayers = new Set((data.gamePlays || []).map(p => p.playerName)).size;
    activeElem.textContent = uniquePlayers;
    try { activeElem.setAttribute('data-last-active-update', new Date().toISOString()); } catch(e){}
  });
}

function startActiveUsersPolling(seconds = activeUsersPollSeconds) {
  stopActiveUsersPolling();
  activeUsersPollSeconds = seconds;
  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  updateActiveUsersOnce();
  activeUsersIntervalId = setInterval(() => {
    updateActiveUsersOnce();
  }, seconds * 1000);
}

function stopActiveUsersPolling() {
  if (activeUsersIntervalId) {
    clearInterval(activeUsersIntervalId);
    activeUsersIntervalId = null;
  }
}

/*
Alternative approaches:
- WebSocket or Server-Sent Events (SSE): push updates from server to clients in real-time.
- Long-polling: client requests and server holds the request until update is available.
- Polling (implemented here): simplest to implement and works without server changes.
*/

function showLogin() {
  document.getElementById('loginModal').style.display = 'flex';
  document.getElementById('dashboardContainer').style.display = 'none';
  document.getElementById('passwordInput').focus();
}

function showDashboard() {
  document.getElementById('loginModal').style.display = 'none';
  document.getElementById('dashboardContainer').style.display = 'block';
}

function checkPassword() {
  const password = document.getElementById('passwordInput').value;
  const errorMsg = document.getElementById('errorMessage');
  
  if (password === ANALYTICS_PASSWORD) {
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
    localStorage.setItem(AUTH_KEY, JSON.stringify({
      timestamp: Date.now(),
      authenticated: true
    }));
    
    errorMsg.textContent = '';
    document.getElementById('passwordInput').value = '';
    showDashboard();
    
    // ‡πÇ‡∏´‡∏•‡∏î Dashboard
    const dashboard = new Dashboard();
  } else {
    errorMsg.textContent = '‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
    document.getElementById('passwordInput').value = '';
    document.getElementById('passwordInput').focus();
    
    // ‡πÄ‡∏Ç‡∏¢‡πà‡∏≤‡∏Å‡∏•‡πà‡∏≠‡∏á
    const modal = document.getElementById('loginModal').firstElementChild;
    modal.style.animation = 'shake 0.5s';
    setTimeout(() => {
      modal.style.animation = '';
    }, 500);
  }
}

function logout() {
  stopAutoRefresh(); // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
  stopActiveUsersPolling(); // ‡∏´‡∏¢‡∏∏‡∏î polling ‡∏Ñ‡πà‡∏≤ active users
  localStorage.removeItem(AUTH_KEY);
  window.location.reload();
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö animation
const style = document.createElement('style');
style.textContent = `
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
    20%, 40%, 60%, 80% { transform: translateX(10px); }
  }
  
  #passwordInput:focus {
    border-color: #667eea;
    outline: none;
  }
  
  button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
`;
document.head.appendChild(style);

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
checkAuth();

// ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Analytics - ‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á)
class AnalyticsSystem {
  constructor() {
    this.storageKey = 'websiteAnalytics';
    this.sessionKey = 'currentSession';
    // ‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å init() ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°
  }

  init() {
    // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ analytics
    // this.trackPageView();
    // this.trackSession();
    // this.setupBeforeUnload();
  }

  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ)
  trackPageView() {
    // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ analytics
    return;
  }

  // ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° Session (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ)
  trackSession() {
    // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ analytics
    return;
  }

  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°
  trackGamePlay(gameType, playerName, teamName, teamColor, score, duration) {
    const analytics = this.getAnalytics();
    
    if (!analytics.gamePlays) analytics.gamePlays = [];
    
    const gamePlay = {
      id: Date.now(),
      timestamp: new Date().toISOString(),
      gameType: gameType,
      playerName: playerName,
      teamName: teamName,
      teamColor: teamColor,
      score: score,
      duration: duration // ‡πÉ‡∏ô‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    };
    
    analytics.gamePlays.push(gamePlay);
    analytics.totalGames = (analytics.totalGames || 0) + 1;
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢
    const totalDuration = analytics.gamePlays.reduce((sum, play) => sum + (play.duration || 0), 0);
    analytics.avgDuration = Math.round(totalDuration / analytics.gamePlays.length);
    
    this.saveAnalytics(analytics);
  }

  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ)
  setupBeforeUnload() {
    // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ analytics
    return;
  }

  getAnalytics() {
    const data = localStorage.getItem(this.storageKey);
    return data ? JSON.parse(data) : {};
  }

  saveAnalytics(data) {
    localStorage.setItem(this.storageKey, JSON.stringify(data));
  }

  clearAnalytics() {
    localStorage.removeItem(this.storageKey);
  }
}

// Dashboard
class Dashboard {
  constructor() {
    this.analytics = new AnalyticsSystem();
    this.charts = {};
    this.refreshTimer = null;
    this.isRefreshing = false;
    this.loadDashboard();
  }

  loadDashboard() {
    if (this.isRefreshing) return; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥
    
    this.isRefreshing = true;
    let data = this.analytics.getAnalytics();
    
    // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    data = filterDataByDate(data);
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Stats Cards
    this.updateStatsCards(data);
    
    // ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢ Charts ‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
    this.destroyCharts();
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Charts ‡πÉ‡∏´‡∏°‡πà
    this.createCharts(data);
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    this.updateActivityTable(data);
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤
    this.updateLastUpdateTime();
    
    this.isRefreshing = false;
  }

  destroyCharts() {
    Object.keys(this.charts).forEach(key => {
      if (this.charts[key]) {
        this.charts[key].destroy();
      }
    });
    this.charts = {};
  }

  updateLastUpdateTime() {
    // ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡πÇ‡∏ã‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ UTC+7 (Asia/Bangkok)
    const now = new Date();
    const opts = { timeZone: 'Asia/Bangkok', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' };
    const dt = new Intl.DateTimeFormat('th-TH', opts).format(now);
    const el = document.getElementById('lastUpdate');
    if (el) {
      el.textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ' + dt;
      console.log('Updated #lastUpdate:', dt);
    } else {
      console.warn('#lastUpdate element not found in DOM');
    }
  }

  updateStatsCards(data) {
    // ‡∏¢‡∏≠‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°
    const totalVisitsElem = document.getElementById('totalVisits');
    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å local ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô
    totalVisitsElem.textContent = (data.totalVisits || 0).toLocaleString();

    // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ distinct clients ‡∏à‡∏≤‡∏Å API /status/active-clients ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ
    fetchDistinctClientsFromAPI().then(count => {
      console.debug('updateStatsCards: localTotal=', data.totalVisits, ' distinctApi=', count);
      if (typeof count === 'number') {
        totalVisitsElem.textContent = count.toLocaleString();
        try { totalVisitsElem.setAttribute('data-last-total-visits-source', 'api'); } catch(e){}
      } else {
        try { totalVisitsElem.setAttribute('data-last-total-visits-source', 'local'); } catch(e){}
      }
    }).catch(err => {
      console.debug('fetchDistinctClientsFromAPI failed:', err);
      try { totalVisitsElem.setAttribute('data-last-total-visits-source', 'local'); } catch(e){}
    });
    
    // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Å‡∏°
    document.getElementById('totalGames').textContent = (data.totalGames || 0).toLocaleString();
    
    // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ `totalHours` ‡∏à‡∏≤‡∏Å API (‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á, 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°) ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å
    const avgElem = document.getElementById('avgTime');
    // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏≠‡∏ú‡∏•
    avgElem.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';

    fetchUsageAverageFromAPI().then(avg => {
      if (typeof avg === 'number') {
        // API ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (totalHours) -> ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
        avgElem.textContent = Number(avg).toFixed(2);
        try { avgElem.setAttribute('data-last-avg-source', 'api'); } catch(e){}
      } else {
        // fallback: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å local data (avgDuration ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ) ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
        const localAvgHours = (data.avgDuration || 0) / 3600;
        avgElem.textContent = Number(localAvgHours).toFixed(2);
        try { avgElem.setAttribute('data-last-avg-source', 'local'); } catch(e){}
      }
    }).catch(err => {
      console.debug('fetchUsageAverageFromAPI failed:', err);
      const localAvgHours = (data.avgDuration || 0) / 3600;
      avgElem.textContent = Number(localAvgHours).toFixed(2);
      try { avgElem.setAttribute('data-last-avg-source', 'local'); } catch(e){}
    });
    
    // Active Users (‡∏Ñ‡πà‡∏≤‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≤‡∏Å API `activeClients` ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å)
    const uniquePlayers = new Set((data.gamePlays || []).map(p => p.playerName)).size;
    const activeElem = document.getElementById('activeUsers');
    // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏≠‡∏ú‡∏•‡∏à‡∏≤‡∏Å API
    activeElem.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å `activeClients` ‡πÄ‡∏™‡∏°‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ (‡πÅ‡∏°‡πâ‡πÄ‡∏õ‡πá‡∏ô 0)
    fetchActiveClientsFromAPI().then(count => {
        console.debug('updateStatsCards: uniquePlayers=', uniquePlayers, ' apiCount=', count);
      if (typeof count === 'number') {
        activeElem.textContent = count.toLocaleString();
      } else {
        // ‡∏ñ‡πâ‡∏≤ API ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á fallback ‡∏à‡∏≤‡∏Å local
        activeElem.textContent = uniquePlayers;
      }
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log ‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÉ‡∏ô DOM (data- attribute) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å DevTools elements
        try { activeElem.setAttribute('data-last-updated', new Date().toISOString()); } catch(e){}
    }).catch(err => {
      console.debug('fetchActiveClientsFromAPI failed:', err);
      activeElem.textContent = uniquePlayers;
        try { activeElem.setAttribute('data-last-updated', new Date().toISOString()); } catch(e){}
    });
  }

  createCharts(data) {
    this.createGameTypeChart(data);
    this.createDailyUsageChart(data);
    this.createAvgTimeChart(data);
    this.createTopPlayersChart(data);
  }

  createGameTypeChart(data) {
    const gamePlays = data.gamePlays || [];
    const gameTypes = {};
    
    gamePlays.forEach(play => {
      gameTypes[play.gameType] = (gameTypes[play.gameType] || 0) + 1;
    });
    
    const ctx = document.getElementById('gameTypeChart').getContext('2d');
    this.charts.gameType = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: Object.keys(gameTypes).map(type => type === 'math' ? '‡∏ß‡∏¥‡∏ä‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå' : '‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'),
        datasets: [{
          data: Object.values(gameTypes),
          backgroundColor: ['#667eea', '#764ba2', '#2ecc71', '#f39c12'],
          borderWidth: 2,
          borderColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  }

  createDailyUsageChart(data) {
    const dailyVisits = data.dailyVisits || {};
    const last7Days = this.getLast7Days();

    const gamemathData = last7Days.map(date => dailyVisits.math?.[date] || 0);
    const gamepictureData = last7Days.map(date => dailyVisits.picture?.[date] || 0);
    const gamethaiData = last7Days.map(date => dailyVisits.thai?.[date] || 0);

    const ctx = document.getElementById('dailyUsageChart').getContext('2d');
    this.charts.dailyUsage = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: last7Days,
        datasets: [
          {
            label: '‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç',
            data: gamemathData,
            backgroundColor: 'rgba(75, 192, 192, 0.6)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1,
          },
          {
            label: '‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ',
            data: gamepictureData,
            backgroundColor: 'rgba(153, 102, 255, 0.6)',
            borderColor: 'rgba(153, 102, 255, 1)',
            borderWidth: 1,
          },
          {
            label: '‡πÇ‡∏´‡∏°‡∏î‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢',
            data: gamethaiData,
            backgroundColor: 'rgba(255, 159, 64, 0.6)',
            borderColor: 'rgba(255, 159, 64, 1)',
            borderWidth: 1,
          },
        ],
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'top',
          },
          title: {
            display: true,
            text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 7 ‡∏ß‡∏±‡∏ô',
          },
        },
        scales: {
          x: {
            beginAtZero: true,
          },
          y: {
            beginAtZero: true,
          },
        },
      },
    });
  }

  createAvgTimeChart(data) {
    const gamePlays = data.gamePlays || [];
    const avgTimeByGame = {};
    const countByGame = {};
    
    gamePlays.forEach(play => {
      if (!avgTimeByGame[play.gameType]) {
        avgTimeByGame[play.gameType] = 0;
        countByGame[play.gameType] = 0;
      }
      avgTimeByGame[play.gameType] += play.duration || 0;
      countByGame[play.gameType]++;
    });
    
    const labels = [];
    const values = [];
    
    Object.keys(avgTimeByGame).forEach(gameType => {
      labels.push(gameType === 'math' ? '‡∏ß‡∏¥‡∏ä‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå' : '‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ');
      // convert average duration (seconds) -> hours, keep two decimals for display in chart
      const hours = avgTimeByGame[gameType] / countByGame[gameType] / 3600;
      values.push(Number(hours.toFixed(2)));
    });
    
    const ctx = document.getElementById('avgTimeChart').getContext('2d');
    this.charts.avgTime = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: '‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)',
          data: values,
          backgroundColor: ['#667eea', '#764ba2'],
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }

  createTopPlayersChart(data) {
    const gamePlays = data.gamePlays || [];
    const playerStats = {};
    
    gamePlays.forEach(play => {
      if (!playerStats[play.playerName]) {
        playerStats[play.playerName] = 0;
      }
      playerStats[play.playerName]++;
    });
    
    const sorted = Object.entries(playerStats)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5);
    
    const ctx = document.getElementById('topPlayersChart').getContext('2d');
    this.charts.topPlayers = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: sorted.map(([name]) => name),
        datasets: [{
          label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏î‡∏™‡∏≠‡∏ö',
          data: sorted.map(([, count]) => count),
          backgroundColor: '#2ecc71',
          borderRadius: 8
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          x: {
            beginAtZero: true
          }
        }
      }
    });
  }

  updateActivityTable(data) {
    const gamePlays = (data.gamePlays || []).slice().reverse().slice(0, 20);
    const tbody = document.getElementById('activityTableBody');
    
    if (gamePlays.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#999;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°</td></tr>';
      return;
    }
    
    tbody.innerHTML = gamePlays.map(play => {
      const time = new Date(play.timestamp);
      const timeStr = `${time.toLocaleDateString('th-TH')} ${time.toLocaleTimeString('th-TH')}`;
      const gameLabel = play.gameType === 'math' ? '‡∏ß‡∏¥‡∏ä‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå' : '‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
      const badgeClass = play.gameType === 'math' ? 'badge-math' : 'badge-picture';
      const durationMin = Math.round(play.duration / 60);
      
      return `
        <tr>
          <td>${timeStr}</td>
          <td><strong>${play.playerName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</strong></td>
          <td>
            <div style="display:flex; align-items:center; gap:8px;">
              <div style="width:20px; height:20px; border-radius:50%; background:${play.teamColor || '#999'}; border:2px solid #333;"></div>
              <span>${play.teamName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>
            </div>
          </td>
          <td><span class="badge ${badgeClass}">${gameLabel}</span></td>
          <td><strong>${play.score || 0}</strong></td>
          <td>${durationMin} ‡∏ô‡∏≤‡∏ó‡∏µ</td>
          <td class="status-completed">‚úì ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</td>
        </tr>
      `;
    }).join('');
  }

  getLast7Days() {
    const days = [];
    for (let i = 6; i >= 0; i--) {
      const date = new Date();
      date.setDate(date.getDate() - i);
      days.push(date.toISOString().split('T')[0]);
    }
    return days;
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
function exportData() {
  const analytics = new AnalyticsSystem();
  const data = analytics.getAnalytics();
  
  const dataStr = JSON.stringify(data, null, 2);
  const dataBlob = new Blob([dataStr], { type: 'application/json' });
  
  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `analytics_${new Date().toISOString().split('T')[0]}.json`;
  link.click();
  
  URL.revokeObjectURL(url);
}

// ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
function clearAllData() {
  if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ')) {
    const analytics = new AnalyticsSystem();
    analytics.clearAnalytics();
    location.reload();
  }
}

// Dashboard ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
let dashboardInstance = null;
let refreshIntervalId = null;
let refreshIntervalSeconds = 10;
// Separate polling for active users (lightweight)
let activeUsersIntervalId = null;
let activeUsersPollSeconds = 10; // default 10 seconds

document.addEventListener('DOMContentLoaded', async () => {
    try {
      // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏™‡∏°‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
      const today = new Date();
      const formattedDate = today.toISOString().split('T')[0]; // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö YYYY-MM-DD

      const datePicker = document.getElementById('datePicker');
      if (datePicker) {
        datePicker.value = formattedDate; // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
        datePicker.addEventListener('change', async (event) => {
          const selectedDate = event.target.value;
          await fetchAndUpdateData(selectedDate);
        });
      }

      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
      await fetchAndUpdateData(formattedDate);
    } catch (error) {
      console.error('Error initializing datepicker or fetching data:', error);
    }
  });

  async function fetchAndUpdateData(date) {
    try {
      console.log(`Fetching data for date: ${date}`); // Debugging log

      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API gamemath
      const gameMathResponse = await fetch(`http://localhost:3000/api/usage-gamemath?date=${date}`);
      const gameMathData = await gameMathResponse.json();
      console.log(`Data from usage-gamemath on ${date}:`, gameMathData);

      if (gameMathData.success) {
        const totalVisitsElement = document.getElementById('totalVisits');
        totalVisitsElement.textContent = gameMathData.count || 0;
      }

      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API gamepicture
      const gamePictureResponse = await fetch(`http://localhost:3000/api/usage-gamepicture?date=${date}`);
      const gamePictureData = await gamePictureResponse.json();
      console.log(`Data from usage-gamepicture on ${date}:`, gamePictureData);

      if (gamePictureData.success && Array.isArray(gamePictureData.data)) {
        const avgTimeElement = document.getElementById('avgTime');
        avgTimeElement.textContent = gamePictureData.data.reduce((sum, item) => sum + item.count, 0);
      } else {
        console.error('Invalid data format for gamePictureData:', gamePictureData);
        const avgTimeElement = document.getElementById('avgTime');
        avgTimeElement.textContent = gamePictureData.count || 0; // ‡πÉ‡∏ä‡πâ count ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ data array
      }

      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å API gamethai
      const gameThaiResponse = await fetch(`http://localhost:3000/api/usage-gamethai?date=${date}`);
      const gameThaiData = await gameThaiResponse.json();
      console.log(`Data from usage-gamethai on ${date}:`, gameThaiData);

      if (gameThaiData.success && Array.isArray(gameThaiData.data)) {
        const activeUsersElement = document.getElementById('activeUsers');
        activeUsersElement.textContent = gameThaiData.data.reduce((sum, item) => sum + item.count, 0);
      } else {
        console.error('Invalid data format for gameThaiData:', gameThaiData);
        const activeUsersElement = document.getElementById('activeUsers');
        activeUsersElement.textContent = gameThaiData.count || 0; // ‡πÉ‡∏ä‡πâ count ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ data array
      }
    } catch (error) {
      console.error('Error fetching data:', error);
    }
  }
</script>

<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const fetchUsageData = async (api, date) => {
      try {
        const response = await fetch(`http://localhost:3000/api/${api}?date=${date}`);
        const data = await response.json();
        console.log(`Data from ${api} on ${date}:`, data); // Debugging log

        if (data.success) {
          if (Array.isArray(data.data)) {
            return data.data.length; // Use the length of the array as the count
          }
          return data.count || 0; // Fallback to count if available
        }
        return 0;
      } catch (error) {
        console.error(`Error fetching data from ${api}:`, error);
        return 0;
      }
    };

    const fetchLast7DaysData = async () => {
      const today = new Date();
      const labels = [];
      const gamemathData = [];
      const gamepictureData = [];
      const gamethaiData = [];

      for (let i = 6; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(today.getDate() - i);
        const formattedDate = date.toISOString().split("T")[0];
        labels.push(formattedDate);

        gamemathData.push(await fetchUsageData("usage-gamemath", formattedDate));
        gamepictureData.push(await fetchUsageData("usage-gamepicture", formattedDate));
        gamethaiData.push(await fetchUsageData("usage-gamethai", formattedDate));
      }

      console.log("Labels:", labels);
      console.log("Game Math Data:", gamemathData);
      console.log("Game Picture Data:", gamepictureData);
      console.log("Game Thai Data:", gamethaiData);

      return { labels, gamemathData, gamepictureData, gamethaiData };
    };

    const renderChart = async () => {
      const { labels, gamemathData, gamepictureData, gamethaiData } = await fetchLast7DaysData();

      const ctx = document.getElementById("dailyUsageChart").getContext("2d");
      new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            {
              label: "‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç",
              data: gamemathData,
              backgroundColor: "rgba(75, 192, 192, 0.6)",
              borderColor: "rgba(75, 192, 192, 1)",
              borderWidth: 1,
            },
            {
              label: "‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ",
              data: gamepictureData,
              backgroundColor: "rgba(153, 102, 255, 0.6)",
              borderColor: "rgba(153, 102, 255, 1)",
              borderWidth: 1,
            },
            {
              label: "‡πÇ‡∏´‡∏°‡∏î‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢",
              data: gamethaiData,
              backgroundColor: "rgba(255, 159, 64, 0.6)",
              borderColor: "rgba(255, 159, 64, 1)",
              borderWidth: 1,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: "top",
            },
            title: {
              display: true,
              text: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 7 ‡∏ß‡∏±‡∏ô",
            },
          },
          scales: {
            x: {
              beginAtZero: true,
            },
            y: {
              beginAtZero: true,
            },
          },
        },
      });
    };

    renderChart();
  });
</script>

</body>
</html>
