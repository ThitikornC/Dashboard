<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô - Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/analytics.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<!-- Login Modal -->
<div id="loginModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:linear-gradient(180deg, #f8f6f0 0%, #fffef8 45%, #fff8e8 55%, #f5f0e5 100%); padding:40px; border-radius:20px; border:6px solid #74640a; box-shadow:1px 1px 0 #000, -8px 6px #3b3305, 0 0 30px rgba(255,230,160,0.7); max-width:400px; width:90%; text-align:center;">
    <h2 style="color:#333; margin-bottom:10px; font-size:28px;">üîí ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö Analytics</h2>
    <p style="color:#666; margin-bottom:30px; font-size:14px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
    
    <input type="password" id="passwordInput" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" 
      style="width:100%; padding:15px; font-size:16px; border:2px solid #ddd; border-radius:10px; margin-bottom:10px; box-sizing:border-box; transition:border-color 0.3s;"
      onkeypress="if(event.key==='Enter') checkPassword()">
    
    <div id="errorMessage" style="color:#e74c3c; font-size:14px; margin-bottom:15px; min-height:20px; font-weight:500;"></div>
    
    <button onclick="checkPassword()" 
      style="width:100%; padding:15px; background:linear-gradient(180deg, #f8f6f0 0%, #fff8e8 100%); color:#000; border:4px solid #74640a; border-radius:10px; font-size:16px; font-weight:700; cursor:pointer; transition:all 0.3s; margin-bottom:10px; box-shadow:1px 1px 0 #000, -4px 3px #3b3305;">
      ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
    </button>
    
    <button onclick="window.location.href='menu.html'" 
      style="width:100%; padding:15px; background:linear-gradient(180deg, #e74c3c 0%, #c0392b 100%); color:white; border:4px solid #8b0000; border-radius:10px; font-size:16px; font-weight:700; cursor:pointer; transition:all 0.3s; box-shadow:1px 1px 0 #000, -4px 3px #4a0000;">
      ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
    </button>
    
    <div style="margin-top:20px; padding-top:20px; border-top:1px solid #eee;">
      <p style="color:#999; font-size:12px; margin:0;">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: <code style="background:#f0f0f0; padding:2px 8px; border-radius:4px; color:#667eea;">240124</code></p>
    </div>
  </div>
</div>

<div class="container" id="dashboardContainer" style="display:none;">
  <!-- Header -->
  <div class="header">
    <h1>üìä Dashboard Analytics</h1>
    <div class="header-actions">
      <button class="btn btn-success" onclick="exportData()">üì• Export Data</button>
      <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <button class="btn btn-danger" onclick="logout()" style="background:#e67e22;">üîí ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      <button class="btn btn-primary" onclick="window.location.href='menu.html'">üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
    </div>
    
    <!-- Date Filter Section -->
    <div style="width:100%; margin-top:15px; padding:15px; background:#f8f9fa; border-radius:10px; border:1px solid #dee2e6;">
      <div style="display:flex; align-items:center; gap:15px; flex-wrap:wrap;">
        <div style="display:flex; align-items:center; gap:8px;">
          <label style="font-weight:600; color:#495057;">üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤:</label>
          <input type="date" id="startDate" onchange="applyDateFilter()" style="padding:8px 12px; border-radius:6px; border:1px solid #ced4da; font-size:14px;">
          <span style="color:#6c757d;">‡∏ñ‡∏∂‡∏á</span>
          <input type="date" id="endDate" onchange="applyDateFilter()" style="padding:8px 12px; border-radius:6px; border:1px solid #ced4da; font-size:14px;">
        </div>
        <div style="display:flex; gap:8px;">
          <button onclick="setDateRange('today')" class="btn-date-filter">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
          <button onclick="setDateRange('yesterday')" class="btn-date-filter">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô</button>
          <button onclick="setDateRange('week')" class="btn-date-filter">7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
          <button onclick="setDateRange('month')" class="btn-date-filter">30 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
          <button onclick="setDateRange('all')" class="btn-date-filter">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>
      </div>
    </div>
    
    <div style="width:100%; margin-top:10px; font-size:13px; color:#666; display:flex; justify-content:space-between; align-items:center;">
      <span>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="lastUpdate">-</span></span>
      <div style="display:flex; align-items:center; gap:10px;">
        <label style="display:flex; align-items:center; gap:5px; cursor:pointer;">
          <input type="checkbox" id="autoRefresh" checked onchange="toggleAutoRefresh()">
          <span>‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>
        </label>
        <select id="refreshInterval" onchange="updateRefreshInterval()" style="padding:5px 10px; border-radius:5px; border:1px solid #ddd; font-size:13px;">
          <option value="5">5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</option>
          <option value="10">10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</option>
          <option value="30" selected>30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</option>
          <option value="60">1 ‡∏ô‡∏≤‡∏ó‡∏µ</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-card-header">
        <div class="stat-title">‡∏¢‡∏≠‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
        <div class="stat-icon" style="background: #e3f2fd;">üë•</div>
      </div>
      <div class="stat-value" id="totalVisits">0</div>
      <div class="stat-change positive">
        <span>‚Üë</span>
        <span id="visitChange">0%</span> ‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-card-header">
        <div class="stat-title">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Å‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô</div>
        <div class="stat-icon" style="background: #f3e5f5;">üéÆ</div>
      </div>
      <div class="stat-value" id="totalGames">0</div>
      <div class="stat-change positive">
        <span>‚Üë</span>
        <span id="gameChange">0%</span> ‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-card-header">
        <div class="stat-title">‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
        <div class="stat-icon" style="background: #fff3e0;">‚è±Ô∏è</div>
      </div>
      <div class="stat-value" id="avgTime">0</div>
      <div class="time-label">‡∏ô‡∏≤‡∏ó‡∏µ/‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
    </div>

    <div class="stat-card">
      <div class="stat-card-header">
        <div class="stat-title">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà Active</div>
        <div class="stat-icon" style="background: #e8f5e9;">‚úÖ</div>
      </div>
      <div class="stat-value" id="activeUsers">0</div>
      <div class="stat-change positive">
        <span>‚Üë</span>
        <span id="activeChange">0%</span> ‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô
      </div>
    </div>
  </div>

  <!-- Charts -->
  <div class="charts-grid">
    <div class="chart-card">
      <h3>üìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</h3>
      <canvas id="gameTypeChart"></canvas>
    </div>

    <div class="chart-card">
      <h3>üìä ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</h3>
      <canvas id="dailyUsageChart"></canvas>
    </div>
  </div>

  <div class="charts-grid">
    <div class="chart-card">
      <h3>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡πÄ‡∏Å‡∏°</h3>
      <canvas id="avgTimeChart"></canvas>
    </div>

    <div class="chart-card">
      <h3>üèÜ Top 5 ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</h3>
      <canvas id="topPlayersChart"></canvas>
    </div>
  </div>

  <!-- Activity Table -->
  <div class="table-card">
    <h3>üìã ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
    <table id="activityTable">
      <thead>
        <tr>
          <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</th>
          <th>‡∏ó‡∏µ‡∏°</th>
          <th>‡πÄ‡∏Å‡∏°</th>
          <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
          <th>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</th>
          <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        </tr>
      </thead>
      <tbody id="activityTableBody">
        <tr>
          <td colspan="7" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Feedback Section -->
  <div class="table-card" style="margin-top: 30px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h3>üí¨ ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
      <button class="btn btn-primary" onclick="refreshFeedback()" id="refreshFeedbackBtn">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
    </div>
    <div id="feedbackContainer" style="max-height: 600px; overflow-y: auto;">
      <p style="text-align: center; color: #999; padding: 40px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞...</p>
    </div>
  </div>
</div>

<script>
// ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
const ANALYTICS_PASSWORD = '240124'; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
const AUTH_KEY = 'analyticsAuth';
const AUTH_TIMEOUT = 3600000; // 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á (‡∏°‡∏¥‡∏•‡∏•‡∏¥‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)

function checkAuth() {
  const auth = localStorage.getItem(AUTH_KEY);
  if (auth) {
    const authData = JSON.parse(auth);
    const now = Date.now();
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤
    if (now - authData.timestamp < AUTH_TIMEOUT) {
      showDashboard();
      return true;
    } else {
      localStorage.removeItem(AUTH_KEY);
    }
  }
  
  showLogin();
  return false;
}

function showLogin() {
  document.getElementById('loginModal').style.display = 'flex';
  document.getElementById('dashboardContainer').style.display = 'none';
  document.getElementById('passwordInput').focus();
}

function showDashboard() {
  document.getElementById('loginModal').style.display = 'none';
  document.getElementById('dashboardContainer').style.display = 'block';
}

function checkPassword() {
  const password = document.getElementById('passwordInput').value;
  const errorMsg = document.getElementById('errorMessage');
  
  if (password === ANALYTICS_PASSWORD) {
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
    localStorage.setItem(AUTH_KEY, JSON.stringify({
      timestamp: Date.now(),
      authenticated: true
    }));
    
    errorMsg.textContent = '';
    document.getElementById('passwordInput').value = '';
    showDashboard();
    
    // ‡πÇ‡∏´‡∏•‡∏î Dashboard
    const dashboard = new Dashboard();
  } else {
    errorMsg.textContent = '‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
    document.getElementById('passwordInput').value = '';
    document.getElementById('passwordInput').focus();
    
    // ‡πÄ‡∏Ç‡∏¢‡πà‡∏≤‡∏Å‡∏•‡πà‡∏≠‡∏á
    const modal = document.getElementById('loginModal').firstElementChild;
    modal.style.animation = 'shake 0.5s';
    setTimeout(() => {
      modal.style.animation = '';
    }, 500);
  }
}

function logout() {
  stopAutoRefresh(); // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
  localStorage.removeItem(AUTH_KEY);
  window.location.reload();
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö animation
const style = document.createElement('style');
style.textContent = `
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
    20%, 40%, 60%, 80% { transform: translateX(10px); }
  }
  
  #passwordInput:focus {
    border-color: #667eea;
    outline: none;
  }
  
  button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  }
`;
document.head.appendChild(style);

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
checkAuth();

// ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Analytics - ‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á)
class AnalyticsSystem {
  constructor() {
    this.storageKey = 'websiteAnalytics';
    this.sessionKey = 'currentSession';
    // ‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å init() ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°
  }

  init() {
    // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ analytics
    // this.trackPageView();
    // this.trackSession();
    // this.setupBeforeUnload();
  }

  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ)
  trackPageView() {
    // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ analytics
    return;
  }

  // ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° Session (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ)
  trackSession() {
    // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ analytics
    return;
  }

  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°
  trackGamePlay(gameType, playerName, teamName, teamColor, score, duration) {
    const analytics = this.getAnalytics();
    
    if (!analytics.gamePlays) analytics.gamePlays = [];
    
    const gamePlay = {
      id: Date.now(),
      timestamp: new Date().toISOString(),
      gameType: gameType,
      playerName: playerName,
      teamName: teamName,
      teamColor: teamColor,
      score: score,
      duration: duration // ‡πÉ‡∏ô‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    };
    
    analytics.gamePlays.push(gamePlay);
    analytics.totalGames = (analytics.totalGames || 0) + 1;
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢
    const totalDuration = analytics.gamePlays.reduce((sum, play) => sum + (play.duration || 0), 0);
    analytics.avgDuration = Math.round(totalDuration / analytics.gamePlays.length);
    
    this.saveAnalytics(analytics);
  }

  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ)
  setupBeforeUnload() {
    // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ analytics
    return;
  }

  getAnalytics() {
    const data = localStorage.getItem(this.storageKey);
    return data ? JSON.parse(data) : {};
  }

  saveAnalytics(data) {
    localStorage.setItem(this.storageKey, JSON.stringify(data));
  }

  clearAnalytics() {
    localStorage.removeItem(this.storageKey);
  }
}

// Dashboard
class Dashboard {
  constructor() {
    this.analytics = new AnalyticsSystem();
    this.charts = {};
    this.refreshTimer = null;
    this.isRefreshing = false;
    this.loadDashboard();
  }

  loadDashboard() {
    if (this.isRefreshing) return; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥
    
    this.isRefreshing = true;
    let data = this.analytics.getAnalytics();
    
    // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    data = filterDataByDate(data);
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Stats Cards
    this.updateStatsCards(data);
    
    // ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢ Charts ‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
    this.destroyCharts();
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Charts ‡πÉ‡∏´‡∏°‡πà
    this.createCharts(data);
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    this.updateActivityTable(data);
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤
    this.updateLastUpdateTime();
    
    this.isRefreshing = false;
  }

  destroyCharts() {
    Object.keys(this.charts).forEach(key => {
      if (this.charts[key]) {
        this.charts[key].destroy();
      }
    });
    this.charts = {};
  }

  updateLastUpdateTime() {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('th-TH');
    document.getElementById('lastUpdate').textContent = timeStr;
  }

  updateStatsCards(data) {
    // ‡∏¢‡∏≠‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°
    document.getElementById('totalVisits').textContent = (data.totalVisits || 0).toLocaleString();
    
    // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Å‡∏°
    document.getElementById('totalGames').textContent = (data.totalGames || 0).toLocaleString();
    
    // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢
    const avgMinutes = Math.round((data.avgDuration || 0) / 60);
    document.getElementById('avgTime').textContent = avgMinutes;
    
    // Active Users (‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô)
    const uniquePlayers = new Set((data.gamePlays || []).map(p => p.playerName)).size;
    document.getElementById('activeUsers').textContent = uniquePlayers;
  }

  createCharts(data) {
    this.createGameTypeChart(data);
    this.createDailyUsageChart(data);
    this.createAvgTimeChart(data);
    this.createTopPlayersChart(data);
  }

  createGameTypeChart(data) {
    const gamePlays = data.gamePlays || [];
    const gameTypes = {};
    
    gamePlays.forEach(play => {
      gameTypes[play.gameType] = (gameTypes[play.gameType] || 0) + 1;
    });
    
    const ctx = document.getElementById('gameTypeChart').getContext('2d');
    this.charts.gameType = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: Object.keys(gameTypes).map(type => type === 'math' ? '‡∏ß‡∏¥‡∏ä‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå' : '‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'),
        datasets: [{
          data: Object.values(gameTypes),
          backgroundColor: ['#667eea', '#764ba2', '#2ecc71', '#f39c12'],
          borderWidth: 2,
          borderColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  }

  createDailyUsageChart(data) {
    const dailyVisits = data.dailyVisits || {};
    const last7Days = this.getLast7Days();
    const values = last7Days.map(date => dailyVisits[date] || 0);
    
    const ctx = document.getElementById('dailyUsageChart').getContext('2d');
    this.charts.dailyUsage = new Chart(ctx, {
      type: 'line',
      data: {
        labels: last7Days.map(date => {
          const d = new Date(date);
          return `${d.getDate()}/${d.getMonth() + 1}`;
        }),
        datasets: [{
          label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°',
          data: values,
          borderColor: '#667eea',
          backgroundColor: 'rgba(102, 126, 234, 0.1)',
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }

  createAvgTimeChart(data) {
    const gamePlays = data.gamePlays || [];
    const avgTimeByGame = {};
    const countByGame = {};
    
    gamePlays.forEach(play => {
      if (!avgTimeByGame[play.gameType]) {
        avgTimeByGame[play.gameType] = 0;
        countByGame[play.gameType] = 0;
      }
      avgTimeByGame[play.gameType] += play.duration || 0;
      countByGame[play.gameType]++;
    });
    
    const labels = [];
    const values = [];
    
    Object.keys(avgTimeByGame).forEach(gameType => {
      labels.push(gameType === 'math' ? '‡∏ß‡∏¥‡∏ä‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå' : '‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ');
      values.push(Math.round(avgTimeByGame[gameType] / countByGame[gameType] / 60)); // ‡∏ô‡∏≤‡∏ó‡∏µ
    });
    
    const ctx = document.getElementById('avgTimeChart').getContext('2d');
    this.charts.avgTime = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: '‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (‡∏ô‡∏≤‡∏ó‡∏µ)',
          data: values,
          backgroundColor: ['#667eea', '#764ba2'],
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }

  createTopPlayersChart(data) {
    const gamePlays = data.gamePlays || [];
    const playerStats = {};
    
    gamePlays.forEach(play => {
      if (!playerStats[play.playerName]) {
        playerStats[play.playerName] = 0;
      }
      playerStats[play.playerName]++;
    });
    
    const sorted = Object.entries(playerStats)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5);
    
    const ctx = document.getElementById('topPlayersChart').getContext('2d');
    this.charts.topPlayers = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: sorted.map(([name]) => name),
        datasets: [{
          label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô',
          data: sorted.map(([, count]) => count),
          backgroundColor: '#2ecc71',
          borderRadius: 8
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          x: {
            beginAtZero: true
          }
        }
      }
    });
  }

  updateActivityTable(data) {
    const gamePlays = (data.gamePlays || []).slice().reverse().slice(0, 20);
    const tbody = document.getElementById('activityTableBody');
    
    if (gamePlays.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#999;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°</td></tr>';
      return;
    }
    
    tbody.innerHTML = gamePlays.map(play => {
      const time = new Date(play.timestamp);
      const timeStr = `${time.toLocaleDateString('th-TH')} ${time.toLocaleTimeString('th-TH')}`;
      const gameLabel = play.gameType === 'math' ? '‡∏ß‡∏¥‡∏ä‡∏≤‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå' : '‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
      const badgeClass = play.gameType === 'math' ? 'badge-math' : 'badge-picture';
      const durationMin = Math.round(play.duration / 60);
      
      return `
        <tr>
          <td>${timeStr}</td>
          <td><strong>${play.playerName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</strong></td>
          <td>
            <div style="display:flex; align-items:center; gap:8px;">
              <div style="width:20px; height:20px; border-radius:50%; background:${play.teamColor || '#999'}; border:2px solid #333;"></div>
              <span>${play.teamName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</span>
            </div>
          </td>
          <td><span class="badge ${badgeClass}">${gameLabel}</span></td>
          <td><strong>${play.score || 0}</strong></td>
          <td>${durationMin} ‡∏ô‡∏≤‡∏ó‡∏µ</td>
          <td class="status-completed">‚úì ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</td>
        </tr>
      `;
    }).join('');
  }

  getLast7Days() {
    const days = [];
    for (let i = 6; i >= 0; i--) {
      const date = new Date();
      date.setDate(date.getDate() - i);
      days.push(date.toISOString().split('T')[0]);
    }
    return days;
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
function exportData() {
  const analytics = new AnalyticsSystem();
  const data = analytics.getAnalytics();
  
  const dataStr = JSON.stringify(data, null, 2);
  const dataBlob = new Blob([dataStr], { type: 'application/json' });
  
  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `analytics_${new Date().toISOString().split('T')[0]}.json`;
  link.click();
  
  URL.revokeObjectURL(url);
}

// ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
function clearAllData() {
  if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ')) {
    const analytics = new AnalyticsSystem();
    analytics.clearAnalytics();
    location.reload();
  }
}

// Dashboard ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å login ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
let dashboardInstance = null;
let refreshIntervalId = null;
let refreshIntervalSeconds = 30;

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
function refreshData() {
  if (!dashboardInstance) return;
  
  const btn = document.getElementById('refreshBtn');
  btn.disabled = true;
  btn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä...';
  
  setTimeout(() => {
    dashboardInstance.loadDashboard();
    btn.disabled = false;
    btn.innerHTML = 'üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä';
    
    // ‡πÅ‡∏™‡∏î‡∏á animation ‡∏™‡∏±‡πâ‡∏ô‡πÜ
    btn.style.transform = 'rotate(360deg)';
    setTimeout(() => {
      btn.style.transform = 'rotate(0deg)';
    }, 300);
  }, 500);
}

// ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
function toggleAutoRefresh() {
  const checkbox = document.getElementById('autoRefresh');
  
  if (checkbox.checked) {
    startAutoRefresh();
  } else {
    stopAutoRefresh();
  }
}

// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
function updateRefreshInterval() {
  const select = document.getElementById('refreshInterval');
  refreshIntervalSeconds = parseInt(select.value);
  
  // ‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
  if (document.getElementById('autoRefresh').checked) {
    stopAutoRefresh();
    startAutoRefresh();
  }
}

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
function startAutoRefresh() {
  stopAutoRefresh(); // ‡∏•‡πâ‡∏≤‡∏á interval ‡πÄ‡∏Å‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô
  
  refreshIntervalId = setInterval(() => {
    if (dashboardInstance && localStorage.getItem(AUTH_KEY)) {
      dashboardInstance.loadDashboard();
    }
  }, refreshIntervalSeconds * 1000);
}

// ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
function stopAutoRefresh() {
  if (refreshIntervalId) {
    clearInterval(refreshIntervalId);
    refreshIntervalId = null;
  }
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
const refreshStyle = document.createElement('style');
refreshStyle.textContent = `
  #refreshBtn {
    transition: transform 0.3s ease;
  }
  
  #refreshBtn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
`;
document.head.appendChild(refreshStyle);

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Dashboard ‡πÅ‡∏•‡∏∞ Auto Refresh ‡∏´‡∏•‡∏±‡∏á Login
function initDashboard() {
  dashboardInstance = new Dashboard();
  startAutoRefresh();
}

// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô checkPassword ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏° Dashboard
const originalCheckPassword = checkPassword;
checkPassword = function() {
  const password = document.getElementById('passwordInput').value;
  const errorMsg = document.getElementById('errorMessage');
  
  if (password === ANALYTICS_PASSWORD) {
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
    localStorage.setItem(AUTH_KEY, JSON.stringify({
      timestamp: Date.now(),
      authenticated: true
    }));
    
    errorMsg.textContent = '';
    document.getElementById('passwordInput').value = '';
    showDashboard();
    
    // ‡πÇ‡∏´‡∏•‡∏î Dashboard ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏° Auto Refresh
    initDashboard();
  } else {
    errorMsg.textContent = '‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà';
    document.getElementById('passwordInput').value = '';
    document.getElementById('passwordInput').focus();
    
    // ‡πÄ‡∏Ç‡∏¢‡πà‡∏≤‡∏Å‡∏•‡πà‡∏≠‡∏á
    const modal = document.getElementById('loginModal').firstElementChild;
    modal.style.animation = 'shake 0.5s';
    setTimeout(() => {
      modal.style.animation = '';
    }, 500);
  }
};

// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô checkAuth
const originalCheckAuth = checkAuth;
checkAuth = function() {
  const auth = localStorage.getItem(AUTH_KEY);
  if (auth) {
    const authData = JSON.parse(auth);
    const now = Date.now();
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤
    if (now - authData.timestamp < AUTH_TIMEOUT) {
      showDashboard();
      initDashboard(); // ‡πÄ‡∏£‡∏¥‡πà‡∏° Dashboard
      return true;
    } else {
      localStorage.removeItem(AUTH_KEY);
    }
  }
  
  showLogin();
  return false;
};

// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
checkAuth();

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡∏à‡∏≤‡∏Å Backend
async function loadFeedback() {
  const container = document.getElementById('feedbackContainer');
  
  try {
    const response = await fetch('/api/feedback');
    const result = await response.json();
    
    if (result.success && result.data.length > 0) {
      container.innerHTML = result.data.reverse().map((item, index) => `
        <div style="background: ${index % 2 === 0 ? '#f9f9f9' : '#fff'}; padding: 20px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #667eea;">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
            <div>
              <span style="background: #667eea; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;">
                #${item.id}
              </span>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 13px; color: #666;">
                üìÖ ${item.createdAt}
              </div>
              <div style="font-size: 11px; color: #999; margin-top: 2px;">
                ${new Date(item.timestamp).toLocaleString('th-TH')}
              </div>
            </div>
          </div>
          <div style="padding: 15px; background: white; border-radius: 8px; border: 1px solid #eee; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word;">
            ${escapeHtml(item.feedback)}
          </div>
        </div>
      `).join('');
    } else {
      container.innerHTML = `
        <div style="text-align: center; padding: 60px 20px; color: #999;">
          <div style="font-size: 48px; margin-bottom: 20px;">üí≠</div>
          <p style="font-size: 18px; margin: 0;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞</p>
          <p style="font-size: 14px; margin-top: 10px;">‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
        </div>
      `;
    }
  } catch (error) {
    console.error('Error loading feedback:', error);
    container.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #e74c3c;">
        <div style="font-size: 48px; margin-bottom: 20px;">‚ö†Ô∏è</div>
        <p style="font-size: 16px;">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÑ‡∏î‡πâ</p>
        <p style="font-size: 14px; color: #999; margin-top: 10px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Server ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà</p>
      </div>
    `;
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞
async function refreshFeedback() {
  const btn = document.getElementById('refreshFeedbackBtn');
  btn.disabled = true;
  btn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
  
  await loadFeedback();
  
  setTimeout(() => {
    btn.disabled = false;
    btn.innerHTML = 'üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä';
  }, 500);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô escape HTML ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô XSS
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ Dashboard ‡∏û‡∏£‡πâ‡∏≠‡∏°
const originalInitDashboard = initDashboard;
initDashboard = function() {
  originalInitDashboard();
  loadFeedback();
  // ‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å initDateFilter() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
  
  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
  setInterval(() => {
    if (document.getElementById('autoRefresh')?.checked) {
      loadFeedback();
    }
  }, refreshIntervalSeconds * 1000);
};

// ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Date Filter
let currentStartDate = null;
let currentEndDate = null;

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Date Filter (‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£ - ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
function initDateFilter() {
  // ‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏£ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
  console.log('Date Filter ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£');
}

// ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤
function setDateRange(range) {
  const today = new Date();
  today.setHours(23, 59, 59, 999);
  
  const startDate = new Date(today);
  const endDate = new Date(today);
  
  switch(range) {
    case 'today':
      startDate.setHours(0, 0, 0, 0);
      break;
    case 'yesterday':
      startDate.setDate(today.getDate() - 1);
      startDate.setHours(0, 0, 0, 0);
      endDate.setDate(today.getDate() - 1);
      endDate.setHours(23, 59, 59, 999);
      break;
    case 'week':
      startDate.setDate(today.getDate() - 7);
      startDate.setHours(0, 0, 0, 0);
      break;
    case 'month':
      startDate.setDate(today.getDate() - 30);
      startDate.setHours(0, 0, 0, 0);
      break;
    case 'all':
      startDate.setFullYear(2000, 0, 1);
      startDate.setHours(0, 0, 0, 0);
      break;
  }
  
  const startInput = document.getElementById('startDate');
  const endInput = document.getElementById('endDate');
  
  if (startInput && endInput) {
    startInput.valueAsDate = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate());
    endInput.valueAsDate = new Date(endDate.getFullYear(), endDate.getMonth(), endDate.getDate());
  }
  
  applyDateFilter();
}

// ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Date Filter
function applyDateFilter() {
  const startInput = document.getElementById('startDate');
  const endInput = document.getElementById('endDate');
  
  if (!startInput || !endInput || !startInput.value || !endInput.value) {
    return;
  }
  
  currentStartDate = new Date(startInput.value);
  currentStartDate.setHours(0, 0, 0, 0);
  
  currentEndDate = new Date(endInput.value);
  currentEndDate.setHours(23, 59, 59, 999);
  
  // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä Dashboard ‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á
  if (dashboardInstance) {
    dashboardInstance.loadDashboard();
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
function filterDataByDate(data) {
  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  if (!currentStartDate || !currentEndDate) {
    console.log('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà - ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
    return data;
  }
  
  console.log('‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà', currentStartDate, '‡∏ñ‡∏∂‡∏á', currentEndDate);
  
  const filtered = {...data};
  
  // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°
  if (filtered.gamePlays && Array.isArray(filtered.gamePlays)) {
    filtered.gamePlays = filtered.gamePlays.filter(play => {
      if (!play.timestamp) return false;
      const playDate = new Date(play.timestamp);
      return playDate >= currentStartDate && playDate <= currentEndDate;
    });
    
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    filtered.totalGames = filtered.gamePlays.length;
    
    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÉ‡∏´‡∏°‡πà
    if (filtered.gamePlays.length > 0) {
      const totalDuration = filtered.gamePlays.reduce((sum, play) => sum + (play.duration || 0), 0);
      filtered.avgDuration = Math.round(totalDuration / filtered.gamePlays.length);
    } else {
      filtered.avgDuration = 0;
    }
  }
  
  // ‡∏Å‡∏£‡∏≠‡∏á dailyVisits
  if (filtered.dailyVisits) {
    const filteredVisits = {};
    Object.keys(filtered.dailyVisits).forEach(dateStr => {
      const visitDate = new Date(dateStr + 'T00:00:00');
      if (visitDate >= currentStartDate && visitDate <= currentEndDate) {
        filteredVisits[dateStr] = filtered.dailyVisits[dateStr];
      }
    });
    filtered.dailyVisits = filteredVisits;
    
    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó totalVisits
    filtered.totalVisits = Object.values(filteredVisits).reduce((sum, count) => sum + count, 0);
  }
  
  console.log('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏≠‡∏á:', {
    totalGames: filtered.totalGames,
    totalVisits: filtered.totalVisits,
    gamePlaysCount: filtered.gamePlays ? filtered.gamePlays.length : 0
  });
  
  return filtered;
}

</script>

</body>
</html>
